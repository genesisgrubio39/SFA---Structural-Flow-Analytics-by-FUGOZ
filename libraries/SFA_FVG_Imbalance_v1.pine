//@version=6
library("SFA_FVG_Imbalance_v1")

// OUTPUTS (8) in exact order:
// 1 bullCreated      bool
// 2 bearCreated      bool
// 3 bullTop          float
// 4 bullBottom       float
// 5 bearTop          float
// 6 bearBottom       float
// 7 bullScore        float
// 8 bearScore        float

import FUGOZ/SFA_Core_v2/1 as CORE

export f_fvg_imbalance_v1(
    string presetMode,
    string filterIntensity,
    bool useCvdFilter
)=>
    //--------------------------------------------------
    // INTERNAL CONSTANTS (ENCAPSULATED)
    //--------------------------------------------------
    int atrLen=14
    int bodyLen=20
    int volLen=60
    int emaLen=50

    float atrMinFactor=0.6
    float dispFactor=1.2
    float volFactor=1.4

    string session1="0200-0500"
    string session2="0830-1030"
    string sessionRTH="0930-1600"

    bool useTrendFilter=true
    bool useSessionFilterCore=true
    bool useDispFilterCore=true
    bool useImbFilterCore=true

    int dispLenCore=20
    float dispRangeMultCore=1.2
    float dispBodyMultCore=1.2
    int imbLenCore=60
    float imbZMinCore=1.0
    int lenTrendCvd=20
    int warmupBarsCore=20

    //--------------------------------------------------
    // PRESET ADAPTATION
    //--------------------------------------------------
    float atrMinEff=atrMinFactor
    float dispEff=dispFactor
    float volEff=volFactor
    string root=syminfo.root

    if presetMode=="Futures"
        atrMinEff:=0.7
        dispEff:=1.5
        volEff:=1.7
    else if presetMode=="Index ETF"
        atrMinEff:=0.6
        dispEff:=1.3
        volEff:=1.6
    else if presetMode=="MegaCap"
        atrMinEff:=0.5
        dispEff:=1.25
        volEff:=1.5
    else if presetMode=="MidCap"
        atrMinEff:=0.4
        dispEff:=1.25
        volEff:=1.4
    else if presetMode=="Auto by asset"
        if syminfo.type=="futures"
            atrMinEff:=0.7
            dispEff:=1.5
            volEff:=1.7
        else if root=="SPY" or root=="QQQ" or root=="IWM" or root=="DIA"
            atrMinEff:=0.6
            dispEff:=1.3
            volEff:=1.6
        else if syminfo.type=="stock"
            atrMinEff:=0.45
            dispEff:=1.25
            volEff:=1.4

    //--------------------------------------------------
    // CORE CONTEXT
    //--------------------------------------------------
    bool isIntraday=timeframe.isintraday
    bool isHtf=isIntraday and timeframe.multiplier>=60

    bool useDispCoreEff=useDispFilterCore and isIntraday and timeframe.multiplier<=15
    bool useImbCoreEff=useImbFilterCore and isIntraday and timeframe.multiplier<=15
    bool useSessCoreEff=useSessionFilterCore and isIntraday and not isHtf

    int warmupEff=warmupBarsCore
    if not isIntraday or timeframe.multiplier>=60
        warmupEff:=0
    else if timeframe.multiplier>=15
        warmupEff:=8
    else if timeframe.multiplier>=5
        warmupEff:=12

    //--------------------------------------------------
    // CORE CALL
    //--------------------------------------------------
    [atrCore,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,_,okImpulse,_,_,upPrice,downPrice,upCvd,downCvd,_,_,_,_,_,_,_,_,_,_]=CORE.f_core_v2(
        atrLen,
        useSessCoreEff,
        session1,
        session2,
        "DAY",
        sessionRTH,
        useDispCoreEff,
        dispLenCore,
        dispRangeMultCore,
        dispBodyMultCore,
        useImbCoreEff,
        imbLenCore,
        imbZMinCore,
        lenTrendCvd,
        1,
        warmupEff
    )

    //--------------------------------------------------
    // BASIC CALCS
    //--------------------------------------------------
    float atr = atrCore  // keep as series alias (indexable)
    float body=math.abs(close-open)
    float avgBody=ta.sma(body,bodyLen)
    float emaTrend=ta.ema(close,emaLen)

    bool trendUp=not useTrendFilter or close>emaTrend
    bool trendDn=not useTrendFilter or close<emaTrend

    float volMA=ta.sma(volume,volLen)
    bool highVol=not na(volMA[1]) and volume[1]>=volMA[1]*volEff

    float body1=math.abs(close[1]-open[1])
    bool dispUp=close[1]>open[1] and body1>=avgBody[1]*dispEff
    bool dispDn=close[1]<open[1] and body1>=avgBody[1]*dispEff

    bool impulseGate=filterIntensity=="Off" or okImpulse
    bool bullCvdGate=not useCvdFilter or (upCvd and not downPrice)
    bool bearCvdGate=not useCvdFilter or (downCvd and not upPrice)

    //--------------------------------------------------
    // FVG DETECTION
    //--------------------------------------------------
    bool bullCreated=false
    bool bearCreated=false
    float bullTop=na
    float bullBottom=na
    float bearTop=na
    float bearBottom=na
    float bullScore=0.0
    float bearScore=0.0

    if bar_index>=2 and not na(atrCore[1])
        float atr1 = math.max(atrCore[1], syminfo.mintick)

        float gTop=low
        float gBot=high[2]
        float gSize=gTop-gBot
        if gTop>gBot and gSize>=atr1*atrMinEff and dispUp and highVol and trendUp and bullCvdGate and impulseGate
            bullCreated:=true
            bullTop:=gTop
            bullBottom:=gBot
            bullScore:=math.max(0.0,gSize/atr1)

        float gTopB=low[2]
        float gBotB=high
        float gSizeB=gTopB-gBotB
        if gTopB>gBotB and gSizeB>=atr1*atrMinEff and dispDn and highVol and trendDn and bearCvdGate and impulseGate
            bearCreated:=true
            bearTop:=gTopB
            bearBottom:=gBotB
            bearScore:=math.max(0.0,gSizeB/atr1)

    [bullCreated,bearCreated,bullTop,bullBottom,bearTop,bearBottom,bullScore,bearScore]
